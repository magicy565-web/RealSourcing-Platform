import React, { useState } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Award, MapPin, Star, ArrowRight, Loader2, Zap, Play } from \"lucide-react\";\nimport { FactoryTrustBadges } from \"./FactoryTrustBadges\";\nimport { FactoryMatchScore } from \"./FactoryMatchScore\";\nimport { FactoryQuickActions } from \"./FactoryQuickActions\";\nimport { FactoryReelPlayer, FactoryReel } from \"./FactoryReelPlayer\";\nimport { ReelOverlay, ReelOverlayData } from \"./ReelOverlay\";\nimport { ReelTimeline, Keyframe } from \"./ReelTimeline\";\n\ninterface Factory {\n  id: string;\n  name: string;\n  city?: string;\n  country?: string;\n  category?: string;\n  logo?: string;\n  status?: string;\n  overallScore?: number;\n}\n\ninterface FactoryCardWithReelProps {\n  factory: Factory;\n  onViewDetails: (factoryId: string) => void;\n  onToggleFavorite: (factoryId: string) => void;\n  isFavoritePending?: boolean;\n  // GTM 3.1 功能\n  matchScore?: { score: number; reason: string; tags: string[] };\n  onlineStatus?: { isOnline: boolean; availableForCall: boolean };\n  onVideoCall?: () => void;\n  onScheduleMeeting?: () => void;\n  onRequestSample?: () => void;\n  isFavorited?: boolean;\n  // Factory Reel 功能\n  reel?: FactoryReel;\n  reelKeyframes?: Keyframe[];\n  trustBadges?: Array<{ label: string; color: \"red\" | \"green\" | \"blue\" | \"purple\" | \"amber\" }>;\n}\n\n/**\n * FactoryCardWithReel 组件\n * \n * 升级版 FactoryCard，集成了 Factory Reel 沉浸式展厅功能\n * \n * 特性：\n * - 卡片内静音视频预览\n * - 点击卡片进入全屏沉浸模式\n * - 平滑的过渡动画\n * - 黑紫色霓虹交互效果\n * - GTM 3.1 核心功能（AI 匹配、在线状态、快捷操作）\n */\nexport function FactoryCardWithReel({\n  factory,\n  onViewDetails,\n  onToggleFavorite,\n  isFavoritePending = false,\n  matchScore,\n  onlineStatus,\n  onVideoCall,\n  onScheduleMeeting,\n  onRequestSample,\n  isFavorited = false,\n  reel,\n  reelKeyframes = [],\n  trustBadges = [],\n}: FactoryCardWithReelProps) {\n  const [isFullscreenReel, setIsFullscreenReel] = useState(false);\n  const [reelCurrentTime, setReelCurrentTime] = useState(0);\n\n  // ── 如果没有 Reel，降级到普通卡片 ────────────────────────────────────────\n  if (!reel) {\n    return (\n      <Card className=\"card-hover overflow-hidden group border-border/60 transition-all duration-300 hover:border-violet-500/50 hover:shadow-[0_0_20px_rgba(124,58,237,0.3)]\">\n        <CardContent className=\"p-0\">\n          {/* 普通卡片内容 */}\n          <div className=\"relative overflow-hidden bg-gradient-to-br from-slate-900 to-slate-950 h-44\">\n            <img\n              src={\n                factory.logo ||\n                \"https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=400&h=250&fit=crop\"\n              }\n              alt={factory.name}\n              className=\"w-full h-full object-cover group-hover:scale-110 transition-transform duration-500\"\n            />\n          </div>\n          {/* ... 其他卡片内容 ... */}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  // ── Reel Overlay 数据 ────────────────────────────────────────────────────\n  const reelOverlayData: ReelOverlayData = {\n    factoryName: factory.name,\n    factoryId: factory.id,\n    isOnline: onlineStatus?.isOnline || false,\n    matchScore: matchScore?.score || 0,\n    trustBadges: trustBadges,\n    isFavorited: isFavorited,\n  };\n\n  // ── 全屏 Reel 模式 ────────────────────────────────────────────────────────\n  if (isFullscreenReel) {\n    return (\n      <div className=\"fixed inset-0 z-50 bg-black flex flex-col\">\n        {/* 关闭按钮 */}\n        <button\n          onClick={() => setIsFullscreenReel(false)}\n          className=\"absolute top-4 right-4 z-10 p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors\"\n        >\n          ✕\n        </button>\n\n        {/* 全屏播放器 */}\n        <div className=\"flex-1 flex items-center justify-center\">\n          <FactoryReelPlayer\n            reel={reel}\n            autoPlay={true}\n            muted={false}\n            className=\"w-full h-full\"\n          />\n        </div>\n\n        {/* 底部信息栏 */}\n        <div className=\"bg-gradient-to-t from-black via-black/80 to-transparent p-6 space-y-4\">\n          {/* Reel Overlay 交互层 */}\n          <ReelOverlay\n            data={reelOverlayData}\n            onCallClick={onVideoCall}\n            onSampleClick={onRequestSample}\n            onFavoriteToggle={onToggleFavorite}\n            onViewDetails={() => {\n              setIsFullscreenReel(false);\n              onViewDetails(factory.id);\n            }}\n          />\n\n          {/* Timeline */}\n          {reelKeyframes.length > 0 && (\n            <ReelTimeline\n              duration={reel.duration}\n              currentTime={reelCurrentTime}\n              keyframes={reelKeyframes}\n              onSeek={(time) => setReelCurrentTime(time)}\n            />\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  // ── 卡片模式（带 Reel 预览） ────────────────────────────────────────────\n  return (\n    <Card className=\"card-hover overflow-hidden group border-border/60 transition-all duration-300 hover:border-violet-500/50 hover:shadow-[0_0_20px_rgba(124,58,237,0.3)] cursor-pointer\">\n      <CardContent className=\"p-0\">\n        {/* ── 视频预览区域 ────────────────────────────────────────────────── */}\n        <div\n          className=\"relative overflow-hidden bg-black h-44 group\"\n          onClick={() => setIsFullscreenReel(true)}\n        >\n          {/* 静音视频预览 */}\n          <FactoryReelPlayer\n            reel={reel}\n            autoPlay={true}\n            muted={true}\n            isCompact={true}\n            className=\"w-full h-full\"\n          />\n\n          {/* 播放按钮覆盖层 */}\n          <div className=\"absolute inset-0 flex items-center justify-center bg-black/0 group-hover:bg-black/30 transition-all duration-300\">\n            <div className=\"w-12 h-12 rounded-full bg-purple-500/80 backdrop-blur-sm border border-purple-400/50 flex items-center justify-center group-hover:bg-purple-500/100 group-hover:scale-110 transition-all\">\n              <Play className=\"w-6 h-6 text-white fill-white ml-0.5\" />\n            </div>\n          </div>\n\n          {/* 在线状态指示器 */}\n          {onlineStatus?.isOnline && (\n            <div className=\"absolute top-3 right-3 flex items-center gap-1.5 bg-emerald-600/90 backdrop-blur-sm px-2.5 py-1.5 rounded-full shadow-lg shadow-emerald-600/30 animate-pulse\">\n              <Zap className=\"w-3.5 h-3.5 text-emerald-200\" />\n              <span className=\"text-xs font-semibold text-emerald-100\">在线</span>\n            </div>\n          )}\n\n          {/* 认证徽章 */}\n          {factory.status === \"active\" && (\n            <div className=\"absolute top-3 left-3 bg-emerald-600/90 backdrop-blur-sm px-2.5 py-1 rounded-full text-white text-xs font-semibold flex items-center gap-1 shadow-lg shadow-emerald-600/20\">\n              <Award className=\"w-3 h-3\" />\n              认证工厂\n            </div>\n          )}\n        </div>\n\n        {/* ── 信息区域 ────────────────────────────────────────────────────── */}\n        <div className=\"p-4 space-y-3\">\n          {/* 工厂名称 + 位置 */}\n          <div>\n            <h3 className=\"font-semibold text-white text-base group-hover:text-purple-300 transition-colors\">\n              {factory.name}\n            </h3>\n            {(factory.city || factory.country) && (\n              <div className=\"flex items-center gap-1 text-xs text-white/60 mt-1\">\n                <MapPin className=\"w-3 h-3\" />\n                <span>\n                  {factory.city}\n                  {factory.city && factory.country ? \", \" : \"\"}\n                  {factory.country}\n                </span>\n              </div>\n            )}\n          </div>\n\n          {/* AI 匹配度 */}\n          {matchScore && (\n            <FactoryMatchScore\n              score={matchScore.score}\n              reason={matchScore.reason}\n              tags={matchScore.tags}\n            />\n          )}\n\n          {/* 信任徽章 */}\n          {trustBadges.length > 0 && (\n            <FactoryTrustBadges badges={trustBadges} />\n          )}\n\n          {/* 快捷操作栏 */}\n          <FactoryQuickActions\n            isOnline={onlineStatus?.isOnline || false}\n            onVideoCall={onVideoCall}\n            onRequestSample={onRequestSample}\n            onToggleFavorite={() => onToggleFavorite(factory.id)}\n            isFavorited={isFavorited}\n            isFavoritePending={isFavoritePending}\n            onViewDetails={() => onViewDetails(factory.id)}\n          />\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default FactoryCardWithReel;\n
